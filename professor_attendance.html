<!DOCTYPE html>

<link rel="stylesheet" type="text/css" href="style.css">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3pro.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

<ul>
	<li style="float:left"><span class="logoname" >I Am Here!</span></li>
	<li style="float:left"><a href="professor.html">Home</a></li>
	<li style="float:left"><a href="professor_classes.html">Classes</a></li>
	<li style="float:left" class="current"><a href="professor_attendance.html">Attendance</a></li>

	<li style="float:right"><a href="/logout">Log Out</a></li>
	<li style="float:right"><span class="name" id="IST_NAME">Name</span></li>
</ul>

<div class="center">
<div class="container" id="attendance_personalization">
		<h1>
			Personalize the attendance checking:
		</h1>

		<table>
		<form id="formId" method="post">
			<tr title="Type of code">
				<td>Type:</td>
				<td>
					<input type="radio" name="code_type" value="L" checked>Letters
					<input type="radio" name="code_type" value="N">Numbers
					<input type="radio" name="code_type" value="LN">Letters and Numbers
				</td>
			</tr>

			<tr title="Number of characters of each code">
				<td>Length:</td>
				<td>
					<select name="code_length" required>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6" selected="selected">6</option>
						<option value="7">7</option>
						<option value="8">8</option>
						</select>
				</td>
			</tr>
			
			<tr title="Time to type each code">	
				<td>Time for each code:</td>
				<td>
					<select name="time" required>
						<option value="8">8</option>
						<option value="9">9</option>
						<option value="10" selected="selected">10</option>
						<option value="11">11</option>
						<option value="12">12</option>
					</select>
				</td>
			</tr>

			<tr title="Number of consecutive codes that the students will need to type">	
				<td>Consecutive codes:</td>
				<td>
					<select name="consecutivecodes" required>
						<option value="3" selected="selected">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6">6</option>
					</select>
				</td>
			</tr>
		</form>
		</table>

    <div style="text-align: center">
      <button class="Bigbutton" id="attendance-button"
        onclick="sendForm()" title="Create a session">
          Create session
      </button>
    </div>
</div>

<div id="attendance_links" style="display:none">
	
	<div class="text-center" id="attendance_qrcode">
	</div>

	<h2 class="text-center" id="attendance_link">
	</h2>

</div>

<div id="attendance_info" style="display:none">
	<p><span id="time_remaining"></span>s</p>
	<p>Code number <span id="code_counter"></span></p>
	<p><span id="randomcode"></span></p>

	<p id="span_c">
		Insert the code in your browser.
	</p>

	<p id="status"> </p>
</div>

<div class="text-center" id="buttons_startstop" style="display:none">
	<button id="b_start" type="button"
    onclick="switchView(2); startAttendance()"
    title="Generate a new sequence">Start</button>
  <button id="b_stop" type="button"
    disabled="true"
    onclick="loadStatus('/getcode/stop'); stopTimer(); switchView(1)"
    title="Stop current sequence">Stop</button>
</div>

</div> <!-- final do container -->


<script src="/qrcode.min.js"></script>

<script>

function generateQRCode(url) {
	var qrcode = new QRCode("attendance_qrcode", {
		text: url,
		width: 512,
		height: 512,
		colorDark : "#000000",
		colorLight : "#ffffff",
		correctLevel : QRCode.CorrectLevel.H
	});
}

function loadName(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			document.getElementById("IST_NAME").innerHTML = this.responseText;
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

var timer;

function startAttendance() {
  timer = setInterval(loadStatusTimer, 1000);
  loadStatus('/getcode');
}

function stopTimer() {
	if(timer) {
		clearInterval(timer);	
	}
}

function loadStatus(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			//document.getElementById("status").innerHTML = this.responseText;
			updateStatus(this.responseText);
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}
function updateStatus(jsonStr) {
	var json = JSON.parse(jsonStr);
	console.log(json);
	var code_element = document.getElementById("randomcode");
	code_element.innerHTML = json.current_code;
	if(json.current_code == "Expired") {
		code_element.className = "expired"; // EXPIRED class
	} else {
		code_element.className = "";
	}
	document.getElementById("code_counter").innerHTML = json.code_counter;
	document.getElementById("time_remaining").innerHTML = json.time_ms;
	updateButtons(json.running);
}

function switchView(arg){
	switch(arg) {
		case 0:
			document.getElementById("attendance_personalization").style.display = "";
			document.getElementById("buttons_startstop").style.display = "none";
  			document.getElementById("attendance_links").style.display = "none";
  			document.getElementById("attendance_info").style.display = "none";
			break;
		case 1:
			document.getElementById("attendance_personalization").style.display = "none";
			document.getElementById("buttons_startstop").style.display = "";
  			document.getElementById("attendance_links").style.display = "";
  			document.getElementById("attendance_info").style.display = "none";
			break;
		case 2:
			document.getElementById("attendance_personalization").style.display = "none";
			document.getElementById("buttons_startstop").style.display = "";
  			document.getElementById("attendance_links").style.display = "none";
  			document.getElementById("attendance_info").style.display = "";
			break;
		default:
			console.log("unknown arg", arg);
			break;

	}
}

function updateButtons(isStarted){
	document.getElementById("b_start").disabled = isStarted;
	document.getElementById("b_stop").disabled = !isStarted;
}

function loadStatusTimer() {
	loadStatus('/status');
}

function sendForm(){
	var formEl = document.getElementById("formId");
	var data = new FormData(formEl);
	var o = {};

	for(var e of data) {
		o[e[0]] = e[1];
	}
	console.log(o);
	
	var json = JSON.stringify(o);

	var xhttp = new XMLHttpRequest();
	var url = "/api/createAttendanceSession"
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			var json = JSON.parse(this.responseText);
			generateQRCode(json.url);
			document.getElementById("attendance_link").innerHTML = json.url;
			switchView(1);
		}
	};

	xhttp.open("POST", url, true);
	xhttp.send(json);
}

loadName("/api/name");

</script>