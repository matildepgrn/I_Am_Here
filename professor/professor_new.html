<!DOCTYPE html>
<head>
  <title>I Am Here!</title>
</head>

<link rel="stylesheet" type="text/css" href="/style.css">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3pro.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">
<script src="https://www.w3schools.com/lib/w3.js"></script>

<!-- Top banner -->
<ul>
	<a href="/professor/courses" style="">
		<li style="float:left" href="/professor/courses"><span class="logoname" >I Am Here!</span></li></a>
	<li style="float:left" class="" onclick="goTo('/professor/studentslist?c='+courseID)"><a>Students</a></li>
	<li style="float:right"><a href="/logout">Log Out</a></li>
	<li style="float:right"><span class="name" id="IST_NAME">Name</span></li>

</ul>
<!-- Top banner -->
<!-- Shift's table -->
<div class="container inlineblock" id="showShifts">
	<div class="menu-container">
		<div class="menu-item item-left menu-button">
			<a href="/professor/classes" class="previous round">&#8249;</a>
		</div>

		<div class="menu-item item-right menu-button">
			<a id="tsv_export_by_secret" onclick="return showLink(this, event)" href="" class="previous round" title="Permanent link to all attendances for this course">
				<span>&#x1f517;</span>
			</a>
		</div>
		<div class="menu-item item-left menu-title" id="courseName_id"></div>
	</div>

	<div id="shiftOn" class="">
		<p class="subTitle">Shifts</p>
		Type:
		<select id="shift_select" onchange="changeShift(this)">
	  		<template id="shiftOnTemplate">
	  			<option></option>
	  		</template>
		</select>
	</div>

	<table class="table-margin">
		<tbody id="shiftTable">
			<tr>
				<th rowspan="2">Shift ID</th>
				<th rowspan="2">Campus</th>
				<th colspan="3">Schedule</th>
				<th rowspan="2">Room</th>
				<th rowspan="2" id="shift_th_type" style="display: none">Type</th>
			</tr>
			<tr>
				<th>Day</th>
				<th>Start</th>
				<th>End</th>
			</tr>
			
			<template id="shiftTemplate">
				<tr class="clickable_different">
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</template>
			<form id="insertShift">
				<tr id="insertShift_tr" style="display: none">
					<td><input type="text" name="shift_id" placeholder="AP34T01" required> </td>
					<td>
						<select name="campus" required>
							<option value="Alameda">Alameda</option>
							<option value="Taguspark">Taguspark</option>
						</select>
					</td>
					<td>
						<select name="day" required>
							<option value="1">Mon</option>
							<option value="2">Tue</option>
							<option value="3">Wed</option>
							<option value="4">Thu</option>
							<option value="5">Fri</option>
							<option value="6">Sat</option>
							<option value="7">Sun</option>
						</select>
					</td>
					<td><input type="time" name="start" required></td>
					<td><input type="time" name="end" required></td>
					<td><input type="text" name="room" placeholder="FA2" required></td>
					<td>
						<select name="type" required>
							<option value="Teórica">Teórica</option>
							<option value="Laboratorial">Laboratorial</option>
							<option value="Seminário">Seminário</option>
							<option value="Prática">Prática</option>
						</select>
					</td>
				</tr>
			</form>
		</tbody>
	</table>

	<div id="invisible-info-shifts" style="display:none">
		<p>Currently, you do not have shifts. Load now from fénix or add one yourself!</p>
		<button onclick="loadShifts()">Load shift(s)</button>
	</div>

	<div style="margin-top: 20px" >
		<button id="toggle_button" onclick="toggleShowNewShift()">Add shift</button>
		<button style="display:none" id="create_add_shift" onclick="insertShiftForm()">Create shift</button>
	</div>

</div>



<!-- Course's table -->
<div class="container inlineblock" id="showHistoryofProfessor" style="display: none">
	<!-- back button -->
	<div class="menu-container">
		<div class="menu-item item-left menu-button">
			<a onclick="switchView(-1)" class="previous round">&#8249;</a>
		</div>

		<div class="menu-item item-left menu-title" id="courseName_id2">
		</div>

		<!--div class="menu-item item-right menu-button">
			<a class="previous round" href="#"
				onclick="toggleImport()" id="import_button"
				title="Import attendance">
				<span class="import">&#x2B07;</span>
			</a>
		</div-->
		<div class="menu-item item-right menu-button">
			<a class="previous round">
			</a>
		</div>

		<!--div class="menu-item item-right menu-button" id="export_button">
			<a id="tsv_export" href="" class="previous round" title="Export">
				<span>&#x1f517;</span>
			</a>
		</div-->

		<div class="menu-item item-right menu-button">
			<a id="tsv_export_shift_by_secret" onclick="return showLink(this, event)" href="" class="previous round" title="Permanent link to this shift's attendances">
				<span>&#x1f517;</span>
			</a>
		</div>

		<div class="menu-item item-right menu-button">
			<a id="b_attendance" class="previous round" href="#"
				onclick="goTo('/professor/attendance?c='+courseID+'&s='+currentShift)"
				title="Generate a new sequence">
				<span>+</span>
			</a>
		</div>


	</div>
	
	<!-- Class number and title -->
	<div>

	<h6 id="noAttendancesText" style="display:none">
		You do not have an attendance for this course. Start one now!
	</h6>

	<div id="teacherOn" class="">
		<p class="subTitle" id="attendancesTitle"><span id="currentShift_display"></span>: attendances</p>
		Professor:
		<select id="professor_select" onchange="changeProfessor(this)">
	  		<template id="teacherOnTemplate">
	  			<option></option>
	  		</template>
		</select>
	</div>

	<div id="importAttendanceDiv" style="display:none">

		<p>Format: <span class="mono">student_number, type of attendance (ok or late)</span><p>
			<form id="importAttendanceID" method="post">
				<table class="invisible-table" style="margin-bottom: 4px">
					<tr>
						<td >Example (on time):</td>
						<td class="mono">ist182083,ok</td>
					</tr>
					<tr>
						<td>Example (late):</td>
						<td class="mono">ist182083,late</td>
					</tr>
					<tr>
						<td>
							Professor:
						</td> 
						<td>
							<input id="professor_number" name="professor_number" pattern="^ist\d\d\d\d\d\d$" type="text" placeholder="istXXXXXX"></input>
						</td>
					</tr>
					<tr>
						<td>
							Shift:
						</td> 
						<td>
							<input id="importattendance_shift" name="shift" type="text"></input>
						</td>
					</tr>
					<tr>
						<td>
							Class number:
						</td> 
						<td>
							<input id="" name="class_number" type="number"></input>
						</td>
					</tr>

					<tr>
						<td>
							Title:
						</td> 
						<td>
							<input id="" name="mytitle" type="text" placeholder="(optional)"></input>
						</td>
					</tr>

					<tr title="Invited lecture or extraordinary class">
						<td></td>
						<td>
							<input type="checkbox" id="addIsExtra" name="is_extra" value="is_extra"> Extra Class
						</td>
					</tr>

					<tr>
						<td colspan="2">
							<textarea oninput="verifyTextArea()" name="file_input" id="myFile_attendances" class="textarea_input"></textarea>
						</td>
					</tr>
					
				</table>

				<button type="button" id="sendImportAttendance" onclick="sendFileAsForm();" disable>Import</button>
				<button type="button" onclick="cancelImport()">Cancel</button>
				
			</form>
		</div>


	<!-- Course's table -->
	<table id="historyTable" class="table-margin">
		<tr>
			<th rowspan="2" class="th-sortable" onclick="w3.sortHTML('#historyTable', '.clickable', 'td:nth-child(1)')">Class #</th>
			<th rowspan="2" class="th-sortable" onclick="w3.sortHTML('#historyTable', '.clickable', 'td:nth-child(2)')">Title</th>
			<th rowspan="2" class="th-sortable" onclick="w3.sortHTML('#historyTable', '.clickable', 'td:nth-child(3)')">Date</th>
			<th colspan="2" class="th-sortable" onclick="w3.sortHTML('#historyTable', '.clickable', 'td:nth-child(4)')">Code</th>
			<th rowspan="2" class="th-sortable" onclick="w3.sortHTML('#historyTable', '.clickable', 'td:nth-child(6)')">Time</th>
			<th rowspan="2" title="Consecutive Codes" class="th-sortable" onclick="w3.sortHTML('#historyTable', '.clickable', 'td:nth-child(7)')"># Codes</th>
			<th rowspan="2" class="th-sortable" onclick="w3.sortHTML('#historyTable', '.clickable', 'td:nth-child(8)')"># Students</th>
			<th rowspan="2"></th>
		</tr>
		<tr>
			<th>Type</th>
			<th>Length</th>
		</tr>
		
		<template id="historyTemplate">
			<tr class="clickable">
				<td class="classCounter"></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td title="Remove attendance"><button onclick="return manuallyRemoveAttendance(this, event)">-</button></td>
			</tr>
		</template>
	</table>

	<p id="historyTable_error"></p>
	</div>
</div>
<!-- Course's table end -->


<!-- Students's table -->
<div>
<div class="container inlineblock" id="showStudentsHistory" style="display: none">
	<div class="menu-container">
		<div class="menu-item item-left menu-button">
			<a onclick="switchView(0);cancelAction();loadHistory(courseID,null,currentShift)"	class="previous round">&#8249;</a>
		</div>

		<!-- Not editing mode -->
		<div id="classInfo">
		<div class="menu-item item-left menu-title" id="currentClassDiv">
			Class <span style="font-weight: bold">#<span id="currentClass"></span></span>
		</div>

		<div class="menu-item item-left item-left-second menu-title" id="currentTitleDiv">
			<span id="currentTitle"></span>
		</div>
		</div>

		<!-- TSV file with all classes -->
		<!--div class="menu-item item-right item-last menu-button">
			<a id="tsv_export_class" href="" class="previous round" title="Export">
				<span>&#x1f517;</span>
			</a>
		</div-->

		<div class="menu-item item-right menu-button">
			<a id="tsv_export_class_by_secret" onclick="return showLink(this, event)" href="" class="previous round" title="Permanent link to this attendance">
				<span>&#x1f517;</span>
			</a>
		</div>



		<div class="menu-item item-right menu-button">
			<a id="editButton" onclick="toggleEdit(this)" class="previous round">
				<span>&#9998;</span>
			</a>
		</div>

	</div>

	<div>

		<!-- Editing mode -->
		<div id="editClassInfo" style="display:none">
			<form id="editClassInfoForm" method="post">
				<table class="invisible-table" style="margin-bottom: 4px">
					<tr>
						<td>
							Class number:
						</td> 
						<td>
							<input id="addClassCounter" name="number" type="number"></input>
						</td>
					</tr>

					<tr>
						<td>
							Title:
						</td> 
						<td>
							<input id="addTitle" name="mytitle" type="text"></input>
						</td>
					</tr>

					<tr title="Invited lecture or extraordinary class">
						<td></td>
						<td>
							<input type="checkbox" id="addIsExtra" name="is_extra" value="is_extra"> Extra Class
						</td>
					</tr>
					
				</table>

				<button type="button" onclick="sendClassInformation()">Save</button>
				<button type="button" onclick="cancelAction(this)">Cancel</button>
				
			</form>
		</div>


		<!-- Student's table -->
		<div style="margin-right: 2px" class="historycolumn" id="historycolumnDiv">

		<table id="studentsTable" class="table-margin">
			<tr>
				<th>IST ID</th>
				<th>Name</th>
				<th>On time</th>
				<th></th>

			</tr>
			
			<template id="studentsTemplate">
				<tr class="clickable">
					<td></td>
					<td></td>
					<td class="td_Special" title="Change student's status (on time vs late)"></td>
					<td><button onclick="manuallyRemoveStudent(this)">-</button></td>
				</tr>
			</template>
		</table>
		
		<form id="formStudent" method="post" style="margin-top: 20px;margin-bottom: 90px">

			<tr title="ist_id">
				<td>
					<input id="inputadd_student" name="ist_id" placeholder="IST ID (ist1XXXXX)">

					  <input id="late_checkbox" type="checkbox" name="late" value="late">Late
					<button id="add_student" type="button" onclick="sendForm();" 
							title="">Add student</button>
				</td>
			</tr>
		</form>
		</div>

		<!-- Student's that failed table -->
		<div style="margin-left: 20px" class="historycolumn" id="attempedstudentsDiv">
		<p>Students that failed to take the attendance:</p>
		<table id="attempedstudentsTable">
			<tr>
				<th>IST ID</th>
				<th colspan="2">Name</th>
			</tr>
			
			<template id="attempedstudentsTemplate">
				<tr>
					<td></td>
					<td></td>
					<td><button onclick="copyISTIDToAddStudent(this)">+</button></td>
				</tr>
			</template>
		</table>
		</div>

	</div>

</div>

</div>
<!-- Students's table end -->

<!-- Students's fingerprint table -->
<div class="container inlineblock" id="showFingerprintHistory" style="display: none">

	<!-- Go back button -->
	<div class="menu-container">
		<div class="menu-item item-left menu-button">
			<a onclick="switchView(1);" href="#"" class="previous round">&#8249;</a>
		</div>

		<div class="menu-item item-left menu-title" id="fingerprintTitle">
			<span style="font-weight: bold" id="currentStudent"></span>'s fingerprint
		</div>
	</div>

	<div>
		<table id="studentsAllTable">
			<tr>
				<th>Class #</th>
				<th>Shift</th>
				<th>Campus</th>
				<th>IP</th>
				<th>User Agent</th>
			</tr>
			
			<template id="studentsAllTemplate">
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</template>
		</table>
	</div>

</div>
<!-- Students's fingerprint table end -->
<!-- GO UP! button -->
	<div id="goUp_spacer"></div>
	<div id="goUp_div" title="Go up">
		<a id="goUp" href="#top">&#9650;</a>
	</div>

<script>

var regex_line = /^ist\d\d\d\d\d\d,(ok|late)$/;
let isEditingClass = false;
let isImportingAttendance = false;
const urlParams = new URLSearchParams(window.location.search);
let courseID = urlParams.get("c");
let historyTable_error = document.getElementById("historyTable_error");
let currentShift;
let isAddingShift = false;

if(courseID) {
	historyTable_error.innerHTML = "";
	loadHistory(courseID,"",currentShift);
	//document.getElementById("tsv_export").href = "/api/attendancefile?c="+courseID;
} else {
	historyTable_error.innerHTML = "CourseID not defined.";
	document.getElementById("historyTable").style.display = "none";
	document.getElementById("b_attendance").style.display = "none";
}

let insertShift_tr = document.getElementById("insertShift_tr");
let create_add_shift = document.getElementById("create_add_shift");
let shift_th_type = document.getElementById("shift_th_type");
let invisible_info_shifts = document.getElementById("invisible-info-shifts");
let toggle_button = document.getElementById("toggle_button");
function toggleShowNewShift() {
	if(isAddingShift) {
		insertShift_tr.style.display = "none";
		shift_th_type.style.display = "none";
		create_add_shift.style.display = "none";
		toggle_button.innerText = "Add new shift";
		invisible_info_shifts.style.display = invisible_info_shifts.old_style_display;
	} else {
		insertShift_tr.style.display = "";
		shift_th_type.style.display = "";
		create_add_shift.style.display = "";
		toggle_button.innerText = "Cancel";
		invisible_info_shifts.old_style_display = invisible_info_shifts.style.display;
		invisible_info_shifts.style.display = "none";
	}
	isAddingShift = !isAddingShift;
}

function insertShiftForm(){
	var formEl = document.getElementById("insertShift");
	if(!formEl.checkValidity()) {
		formEl.reportValidity();
		return;
	}
	var data = new FormData(formEl);
	var o = {};
	o.courseID = courseID;
	for(var e of data) {
		o[e[0]] = e[1];
	}
	
	var json_string = JSON.stringify(o);
	var xhttp = new XMLHttpRequest();
	var url = "/api/insertshift";
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			toggleShowNewShift();
			loadShiftsByCourseID();
		}
	}

	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}

function goTo(url) {
	window.location.replace(url);
}

var myFile_attendances = document.getElementById("myFile_attendances");
var sendImportAttendance = document.getElementById("sendImportAttendance");

function verifyTextArea() {
	var text = myFile_attendances.value;
	var lines = text.split('\n');

	for(let l of lines) {
		if(!l.match(regex_line)) {
			console.log('Invalid line:', l);
			myFile_attendances.classList.add("invalidLine");
			sendImportAttendance.disabled = true;
			return;
		}
	}
	sendImportAttendance.disabled = false;
	myFile_attendances.classList.remove("invalidLine");
}

function sendFileAsForm(){
	var formEl = document.getElementById("importAttendanceID");
	var data = new FormData(formEl);
	var o = {};
	for(var e of data) {
		o[e[0]] = e[1];
	}
	o.courseID = courseID;
	
	var json_string = JSON.stringify(o);
	var xhttp = new XMLHttpRequest();
	var url = "/api/importattendance";
		xhttp.onreadystatechange = function() {
			if(this.readyState == 4 && this.status == 200) {
				toggleImport();
				formE1.reset;
				loadHistory(courseID,null,currentShift);
			}
	}
	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}


function cancelAction(button_element) {
	document.getElementById("editButton").classList.remove("active");
	document.getElementById("classInfo").style.display = "";
	document.getElementById("editClassInfo").style.display = "none";

	isEditingClass = false;
}

function editTitleNumber(button_element) {
	document.getElementById("editClassInfo").style.display = "";
	document.getElementById("editButton").classList.add("active");

	var attendanceID = button_element.attendanceID;

	isEditingClass = true;

	loadAttendanceInformation("/api/attendanceinfo?a="+attendanceID, attendanceID);
}

function toggleEdit(button_element) {
	if(isEditingClass) {
		return cancelAction(button_element);
	} else {
		return editTitleNumber(button_element);
	}
}

function toggleImport() {
	if(isImportingAttendance) {
		return cancelImport();
	} else {
		return importAttendance();
	}
}

function importAttendance(){
	document.getElementById("b_attendance").style.display = "none";
	document.getElementById("import_button").classList.add("active");
	document.getElementById("teacherOn").style.display = "none";
	document.getElementById("historyTable").style.display = "none";
	document.getElementById("importAttendanceDiv").style.display = "";
	isImportingAttendance = true;
}

function cancelImport() {
	document.getElementById("b_attendance").style.display = "";
	document.getElementById("import_button").classList.remove("active");
	document.getElementById("teacherOn").style.display = "";
	document.getElementById("historyTable").style.display = "";
	document.getElementById("importAttendanceDiv").style.display = "none";
	isImportingAttendance = false;
}


function loadShiftsByCourseID() {
	var url = "/api/getshifts?c=" + courseID;
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var shifts = JSON.parse(this.responseText);
				updateSelectShift(shifts);
			} else {
				console.log("Error loading shifts:", this.status);
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}

let global_shifts_wrapper;

function updateSelectShift(shifts) {
	global_shifts_wrapper = shifts;
	var template = document.getElementById("shiftOnTemplate");
	var select = document.getElementById("shift_select");
	let types = [];

	removeSelectOptions("shift_select");

	for(let s of shifts) {
		if(!types.includes(s.type)) {
			types.push(s.type);
		}
	}

	for(let i = 0; i < types.length; i++) {
		var option = template.content.querySelector("option").cloneNode(true);
		option.value = option.innerText = types[i];
		select.appendChild(option);

		if(types[i] == "TEORICA") {
			select.selectedIndex = i;
		}
	}

	changeShift(select);
}

function changeShift(select) {
	showShifts(select.value);
}

function showShifts(myType = "TEORICA") {
	var template = document.getElementById("shiftTemplate");
	var table = document.getElementById("shiftTable");
	var shifts = global_shifts_wrapper;
	removeTrs(table.getElementsByTagName("tr"), 2, 1);
	var ids_consecutive = 0;
	var select = document.getElementById("shift_select");
	
	if(shifts.length > 0) {
		for(let i = 1; i < shifts.length; i++) {
			if(shifts[i].shift_id == shifts[i-1].shift_id) {
				let first_index = shifts[i-1].first_index;
				if(first_index) {
					if(shifts[first_index].repeatedCount) {
						shifts[first_index].repeatedCount ++;
					} else {
						shifts[i].repeatedCount = 1;
						shifts[first_index].repeatedCount = 1;
					}
				} else {
					shifts[i].first_index = i-1;
					shifts[i-1].repeatedCount = 2;
				}
			}
		}
		for(let i = 0; i < shifts.length; i++) {
			let shifts_i = shifts[i];
			if(shifts_i.type == myType) {
				addShifts(table, template, shifts_i, shifts_i.secret, shifts_i.shift_id, shifts_i.campus, shifts_i.week_day, shifts_i.start, shifts_i.end, shifts_i.room);
			}
		} 
	} else {
		document.getElementById("invisible-info-shifts").style.display = "";
		document.getElementById("shiftOn").style.display = "none";
	}
};

var week_day_list = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

function addShifts(table, template, shifts_i, secret, id, campus, week_day, start, end, room) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;
	tr_clone.shift_id = id;
	tr_clone.secret = secret;
	week_day = week_day_list[week_day];

	start = start.substring(0,5);
	end = end.substring(0,5);
	
	for(let x = 0; x < tds.length; x++) {
		tds[x].innerText = arguments[x+4];
	}

	if(shifts_i.first_index != undefined) {
		tds[1].parentElement.removeChild(tds[1]);		// remove 1o a coluna CAMPUS
		tds[0].parentElement.removeChild(tds[0]);
	} else if(shifts_i.repeatedCount) {
		tds[0].rowSpan = shifts_i.repeatedCount;
		tds[1].rowSpan = shifts_i.repeatedCount;
	}

	tr_clone.onclick = function() {
		loadHistory(courseID, null, this.shift_id);
		switchView(0);
		currentShift = this.shift_id;
		let link = window.location.protocol + "//" + window.location.host + "/tsv/course/shift?s=" + this.secret;
		document.getElementById("tsv_export_shift_by_secret").href = link;
	};
	//table.appendChild(tr_clone);
	table.insertBefore(tr_clone, table.childNodes[table.childNodes.length-2]);
}


function sendClassInformation(){
	var formE1 = document.getElementById("editClassInfoForm");
	var data = new FormData(formE1);
	var o = {};
	for(var e of data) {
		o[e[0]] = e[1];
	}
	var table = document.getElementById("studentsTable");
	
	var json_string = JSON.stringify(o);

	var xhttp = new XMLHttpRequest();
	var url = "/api/updateClassInformation?a="+table.attendanceID;
	if(confirm("Are you sure you want to update this information?")) {
		xhttp.onreadystatechange = function() {
			if(this.readyState == 4 && this.status == 200) {
				document.getElementById("editButton").classList.remove("active");
				document.getElementById("classInfo").style.display = "";
				document.getElementById("editClassInfo").style.display = "none";

				var table = document.getElementById("studentsTable");
				var classcounter = table.classcounter;
				loadStudents('/api/getattendancehistory?rid='+table.attendanceID, classcounter);
				loadAttendanceInformation("/api/attendanceinfo?a="+table.attendanceID,table.attendanceID);
			}
		};

	xhttp.open("POST", url, true);
	xhttp.send(json_string);
	}
}

function loadAttendanceInformation(url, attendanceID) {
	var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if(this.readyState == 4) {
				if(this.status == 200) {
					var attendanceInfo = JSON.parse(this.responseText);
					document.getElementById("addTitle").value = attendanceInfo.title;
					if(attendanceInfo.is_extra == 1) {
						document.getElementById("addIsExtra").checked = 1;
					} else {
						document.getElementById("addIsExtra").checked = 0;
					}
					document.getElementById("addClassCounter").value = attendanceInfo.number;
					//document.getElementById("tsv_export_class").href = "/api/classattendancefile?c="+courseID+"&a="+attendanceID+"&s="+currentShift;
					document.getElementById("currentClass").innerHTML = attendanceInfo.number;
					document.getElementById("currentTitle").innerHTML = attendanceInfo.title;

					if(attendanceInfo.number > 0) {			
						document.getElementById("currentClassDiv").style.display = "";

					} else {			// in case is extra class (and no number)
						document.getElementById("currentTitleDiv").style.display = "";
						document.getElementById("currentClassDiv").style.display = "none";
					}
				} else {
					console.log("Error loadAttendanceInformation:", this.status);
				}
			}
		};
		xhttp.open("GET", url, true);
		xhttp.send();
}

function changeProfessor() {
	var select = document.getElementById("professor_select");
	loadHistory(courseID, select.value, currentShift);
}

function loadHistory(mycourseID, ist_id, shift) {
	let url = "/api/history?c=" + mycourseID + (ist_id ? ("&i=" + ist_id) : "") + "&s=" + shift;
	currentShift = shift;
	document.getElementById("currentShift_display").innerHTML = currentShift;
	document.getElementById("importattendance_shift").value = currentShift;
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var history = JSON.parse(this.responseText);
				showHistory(history);
			} else {
				//todo
				console.log("Error loading history:", this.status);
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}

function loadProfessorsByCourse(courseID) {
	let url = "/api/professorsbycourse?c="+courseID;
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if(this.readyState == 4) {
				if(this.status == 200) {
					var json = JSON.parse(this.responseText);
					showProfessors(json);
				} else {
					console.log("Error loading professor by course:", this.status);
				}
			}
		};
		xhttp.open("GET", url, true);
		xhttp.send();
} 

function showProfessors(json) {
	var profs = json.rows;
	var template = document.getElementById("teacherOnTemplate");
	var select = document.getElementById("professor_select");

	for(let i = 0; i < profs.length; i++) {
		var option = template.content.querySelector("option").cloneNode(true);
		option.value = profs[i].ist_id;
		option.innerText = profs[i].name + " (" + profs[i].ist_id + ")";
		select.appendChild(option);

		if(profs[i].ist_id == json.ist_id) {
			select.selectedIndex = i;
		}
	}
};

function removeSelectOptions(id) {
	var x = document.getElementById(id);
	for(let l = x.length-1; l >= 0; l--) {
		x.remove(l);
	}
}



function showHistory(history_wrapper) {
	var template = document.getElementById("historyTemplate");
	var table = document.getElementById("historyTable");
	var history = history_wrapper.history.rows;
	table.ist_id = history_wrapper.history.ist_id;
	removeTrs(table.getElementsByTagName("tr"));
	document.getElementById("professor_select").value = table.ist_id;
	document.getElementById("courseName_id").innerHTML = history_wrapper.courseName;
	document.getElementById("courseName_id2").innerHTML = history_wrapper.courseName;
	let secret = history_wrapper.secret;

	let link = window.location.protocol + "//" + window.location.host + "/tsv/course?s=" +  secret;
	document.getElementById("tsv_export_by_secret").href = link;

	if(history.length > 0) {
		//document.getElementById("export_button").style.display = "";
		document.getElementById("noAttendancesText").style.display = "none";
		document.getElementById("attendancesTitle").style.display = "";
		document.getElementById("historyTable").style.display = "";
		for(let i = 0; i < history.length; i++) {
			let hist_i = history[i];
			addHistory(table, template, hist_i.secret, hist_i.attendanceID, hist_i.number, hist_i.title, hist_i.date, hist_i.code_type, hist_i.code_length, hist_i.total_time_s, hist_i.consecutive_codes, hist_i.count, hist_i.is_extra);
		} 
	} else {
		//document.getElementById("export_button").style.display = "none";
		document.getElementById("historyTable").style.display = "none";
		document.getElementById("noAttendancesText").style.display = "";
		document.getElementById("attendancesTitle").style.display = "none";
	}
	
};

function addHistory(table, template, secret, attendanceID, classcounter, mytitle, date, code_type, code_length, total_time_s, consecutive_codes, count, is_extra) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;
	tr_clone.myattendanceID = attendanceID;
	tr_clone.classcounter = classcounter;
	tr_clone.mytitle = mytitle;
	tr_clone.secret = secret;
	tds[0].innerText = (is_extra == 1) ? "-" : classcounter;
	
	for(let x = 1; x < tds.length - 1; x++) {	//a partir de "date"
		tds[x].innerText = arguments[x+4];
	}
	tr_clone.onclick = function() {
		loadStudents("/api/getattendancehistory?rid="+this.myattendanceID, this.classcounter, mytitle);
		switchView(1);

		let link = window.location.protocol + "//" + window.location.host + "/tsv/course/class?s=" + this.secret;
		document.getElementById("tsv_export_class_by_secret").href = link;
	};
	table.appendChild(tr_clone);
}

function loadName(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				document.getElementById("IST_NAME").innerHTML = this.responseText;
				//document.getElementById("professor_select").innerHTML = this.responseText;
			} else {
				document.getElementById("IST_NAME").innerHTML = "<i>error getting username: " + this.status + "</i>";
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}

function loadStudents(url, classcounter, title) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var studentshistory = JSON.parse(this.responseText);
				showStudents(studentshistory, classcounter, title);
			} else {
				//todo
				console.log("Error loading students:", this.status);
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}

function removeTrs(old_tr, num=1, leaveEnd=0) {
	for(let l = old_tr.length-1-leaveEnd; l > num-1; l--) {
		old_tr[l].parentElement.removeChild(old_tr[l]);
	}
}

function showStudents(studentshistory, classcounter, title) {
	var template = document.getElementById("studentsTemplate");
	var table = document.getElementById("studentsTable");
	var template_tried = document.getElementById("attempedstudentsTemplate");
	var table_tried = document.getElementById("attempedstudentsTable");
	var button_edit = document.getElementById("editButton");
	removeTrs(table.getElementsByTagName("tr"));
	removeTrs(table_tried.getElementsByTagName("tr"));
	var rows = studentshistory.rows;
	var rows_fingerprints = studentshistory.rows_fingerprints;
	var rows_studentsThatTried = studentshistory.rows_studentsThatTried;
	var rows_late = studentshistory.rows_late;
	var rows_manually = studentshistory.rows_manually;
	table.attendanceID = studentshistory.attendanceID;
	table.courseID = courseID;
	table.classcounter = classcounter;
	table_tried.attendanceID = studentshistory.attendanceID;
	table_tried.classcounter = classcounter;
	table.title = title;
	button_edit.attendanceID = studentshistory.attendanceID;

	loadAttendanceInformation("/api/attendanceinfo?a="+table.attendanceID, table.attendanceID)
	

	for(let i = 0; i < rows.length; i++) {
		var studentCheating = isIn(rows_fingerprints, rows[i].ist_id);
		var studentLate = isIn(rows_late, rows[i].ist_id);
		var studentManually = isIn(rows_manually, rows[i].ist_id);
		addStudent(table, template, rows[i].ist_id, rows[i].name, studentLate, studentManually, studentCheating, false);
	}
	if(rows_studentsThatTried.length > 0) {
		table.parentElement.classList.add("historycolumn");
		document.getElementById("attempedstudentsDiv").style.display = "";
		for(let j = 0; j < rows_studentsThatTried.length; j++) {
		addStudent(table_tried, template_tried, rows_studentsThatTried[j].ist_id, rows_studentsThatTried[j].name, false, false, false, true);
		}
	} else {
		document.getElementById("attempedstudentsDiv").style.display = "none";
		table.parentElement.classList.remove("historycolumn");
	}
};

function isIn(rows, ist_id) {
	for(let x = 0; x < rows.length; x++) {
		if(rows[x].ist_id == ist_id) {
			return true;
		}
	}
	return false;
}

function addStudent(table, template, ist_id, name, late, manually, studentCheating, isTableTried) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;
	tr_clone.ist_id = ist_id;
	tr_clone.std_name = name;
	if(studentCheating){
		tr_clone.classList.add("less_suspicious");
	}
	if(isTableTried == true) {
		for(let x = 0; x < tds.length - 1; x++) {
			tds[x].innerText = arguments[x+2];
		}
	} else {
		for(let x = 0; x < tds.length - 2; x++) {		// -2 por causa da coluna "extra" e do "on time"
			tds[x].innerText = arguments[x+2];
		}
		if(late) {			// coluna: on time
			tds[2].classList.add("toRed");
			tds[2].innerHTML = "X";	//cruz
		} else {
			tds[2].classList.add("toGreen");
			tds[2].innerHTML = "&#10004;";	//check
		}
	
	tds[2].my_isLate = late;
	tds[0].onclick = tds[1].onclick = function() {
		let table = document.getElementById("studentsTable");
		let tr = this.parentElement;
		document.getElementById("currentStudent").innerHTML = tr.std_name;
		loadStudentsHistory("/api/studentshistory?i="+tr.ist_id+"&c="+courseID);
		switchView(2);
	};
	tds[2].onclick = function() {
		let table = document.getElementById("studentsTable");
		let tr = this.parentElement;
		let new_isLate = !this.my_isLate;	//toggle state
		json = {};
		json.a = table.attendanceID;
		json.i = tr.ist_id;
		json.late = new_isLate;
		loadisLate("/api/setLate", json, this);
	};
	}
	table.appendChild(tr_clone);
}

function manuallyRemoveStudent(button_element) {
	if(confirm("Are you sure you want to remove this students from this attendance?")) {
	button_element.parentElement.parentElement.classList.add('removedStyle');
	var ist_id = button_element.parentElement.parentElement.ist_id;
	var attendanceID = button_element.parentElement.parentElement.parentElement.attendanceID;
	var classcounter = button_element.parentElement.parentElement.parentElement.classcounter;
	removeStudent('/api/manuallyRemoveStudent?i='+ist_id+'&a='+attendanceID, button_element, attendanceID, classcounter);
	}
}

function manuallyRemoveAttendance(button_element, event) {
	if(confirm("Are you sure you want to delete this attendance?")) {
		var attendanceID = button_element.parentElement.parentElement.myattendanceID;
		var prof_id = button_element.parentElement.parentElement.parentElement.ist_id;
		removeAttendance('/api/manuallyRemoveAttendance?a='+attendanceID+'&i='+prof_id, button_element, attendanceID);
	}
	event.preventDefault();
}

function removeAttendance(url, button_element, attendanceID) {

	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				button_element.disabled=true;
				loadHistory(courseID,null,currentShift);
				switchView(0);
			} else {
				console.log("Error removing attendance:", this.status);
				alert("Error removing attendance. Try again please.");
			}
		}
	};
	xhttp.open("POST", url, true);
	xhttp.send(JSON.stringify({}));
}

function showLink(element, event) {
	prompt("Copy the link:", element.href);
	event.preventDefault();
}

function removeStudent(url, button_element, attendanceID, classcounter) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				button_element.disabled=true;
				// to reload the page
				loadStudents('/api/getattendancehistory?rid='+attendanceID, classcounter);
			} else {
				console.log("Error removing student:", this.status);
				alert("Error removing student. Try again please.");
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}

function sendForm(){
	var formEl = document.getElementById("formStudent");
	var data = new FormData(formEl);
	var o = {};
	var table = document.getElementById("studentsTable");
	o.attendanceID = table.attendanceID;
	for(var e of data) {
		o[e[0]] = e[1];
	}
	
	var json_string = JSON.stringify(o);
	var xhttp = new XMLHttpRequest();
	var url = "/api/addmanually";
	if(confirm("Are you sure you want to add this students?")) {
		xhttp.onreadystatechange = function() {
			if(this.readyState == 4 && this.status == 200) {
				var json = JSON.parse(this.responseText);
				var template = document.getElementById("studentsTemplate");
				var table = document.getElementById("studentsTable");
				var classcounter = table.classcounter;
				addStudent(table, template, o.ist_id, "(loading)");
				var inputadd_student = document.getElementById("inputadd_student");
				inputadd_student.value = "";
				loadStudents('/api/getattendancehistory?rid='+table.attendanceID, classcounter);
			}
		};
	xhttp.open("POST", url, true);
	xhttp.send(json_string);
	}
}

function loadisLate(url, json, td) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				if(td.innerText == "X") {
					td.classList.remove("toRed");
					td.classList.add("toGreen");
					td.innerHTML = "&#10004;";
				} else {
					td.classList.remove("toGreen");
					td.classList.add("toRed");
					td.innerHTML = "X";
				}
			} else {
				console.log("Error loading isLate", this.status);
				alert("Could not change student's status");
			}
		}
	};
	var json_string = JSON.stringify(json);
	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}

function loadShifts() {
	var url = "/api/loadshifts";

	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
			} else {
			}
		}
	};

	json = {};
	json.courseID = courseID;
	var json_string = JSON.stringify(json);
	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}

function loadStudentsHistory(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var stds_history = JSON.parse(this.responseText);
				showAllStudentsHistory(stds_history);
			} else {
				console.log("Error loadStudentsHistory:", this.status);
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}

function showAllStudentsHistory(stds_wrapper) {
	var template = document.getElementById("studentsAllTemplate");
	var table = document.getElementById("studentsAllTable");
	var stds = stds_wrapper;
	removeTrs(table.getElementsByTagName("tr"));

	console.log(stds);
	if(stds.length > 0) {
		for(let i = 0; i < stds.length; i++) {
			let hist_i = stds[i];
			addAllStudentsHistory(table, template, hist_i.number, hist_i.shift_id, hist_i.campus, hist_i.ip, hist_i.useragent);
		} 
	} else {
		//TODO
	}
	
};

function addAllStudentsHistory(table, template, number, shift, campus, ip, useragent) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;
	
	for(let x = 0; x < tds.length; x++) {
		tds[x].innerText = arguments[x+2];
	}

	if(!number) {
		tds[0].innerText = "-";
	}
	
	table.appendChild(tr_clone);
}

function copyISTIDToAddStudent(button) {
	var inputadd_student = document.getElementById("inputadd_student");
	inputadd_student.value = button.parentElement.parentElement.ist_id;

	sendForm();
}

function switchView(arg){
	switch(arg) {
		case -1:
			loadShiftsByCourseID();
			document.getElementById("showShifts").style.display = "";
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 0:
			document.getElementById("showShifts").style.display = "none";
			document.getElementById("showHistoryofProfessor").style.display = "";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 1:
			document.getElementById("showShifts").style.display = "none";
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 2:
			document.getElementById("showShifts").style.display = "none";
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "";
			break;
		default:
			console.log("unknown arg", arg);
			break;
	}
}

loadName("/api/name");
loadProfessorsByCourse(courseID);
loadShiftsByCourseID();

</script>