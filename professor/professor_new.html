<!DOCTYPE html>
<head>
  <title>I Am Here!</title>
</head>

<link rel="stylesheet" type="text/css" href="/style.css">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3pro.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

<ul>
	<a href="/professor/courses" style="">
		<li style="float:left" href="/professor/courses">
			<span class="logoname" >I Am Here!</span>	
		</li>
	</a>
	<li style="float:left" class="current"><a onclick="goTo('/professor/new?c='+courseID)">Attendance</a></li>
	<li style="float:left" class="" onclick="goTo('/professor/studentslist?c='+courseID)"><a>Students</a></li>
	<li style="float:right"><a href="/logout">Log Out</a></li>
	<li style="float:right"><span class="name" id="IST_NAME">Name</span></li>

</ul>

<div class="container" id="showHistoryofProfessor">
	<a href="/professor/classes" class="goBack previous round">&#8249;</a>
	<center class="center">
	<div>
		<h3 class="firstTitle"><span id="courseName_id"></span></h3>
	</div>
	
	<h5>History Table</h5>

	<h6 id="noAttendancesText" style="display:none">
		You do not have an attendance for this course. Start one now!
	</h6>
		
	<button id="b_attendance" type="button"
		onclick="goTo('/professor/attendance?c='+courseID)"
		title="Generate a new sequence">Start new attendance
	</button>
	
	<button onclick="goTo()" title="History TSV" id="tsvlink_b">
		&#11008;
	</button>
	<table id="historyTable">
			<tr>
				<th rowspan="2">Class #</th>
				<th rowspan="2">Title</th>
				<th rowspan="2">Date</th>
				<th colspan="2">Code</th>
				<th rowspan="2">Time</th>
				<th rowspan="2" title="Consecutive Codes"># Codes</th>
				<th rowspan="2"># Students</th>
				<th rowspan="2"></th>
			</tr>
			<tr>
				<th>Type</th>
				<th>Length</th>
			</tr>
			
			<template id="historyTemplate">
				<tr class="clickable">
					<td class="classCounter"></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td title="Remove attendance"><button onclick="return manuallyRemoveAttendance(this, event)">-</button></td>
				</tr>
			</template>


		</table>

		<p id="historyTable_error"></p>

	</center>
</div>

<div>
<div class="container" id="showStudentsHistory" style="display: none">
	<div>
		<div style="float: left; margin-top:-25px">
			<a onclick="switchView(0);"	class="goBack previous round">&#8249;</a>
		</div>

		<div style="float: right; margin-top:-25px; margin-right:100px;">
			<a id="editButton" onclick="return editTitleNumber(this)" class="goBack previous round">&#9998;</a>
		</div>
	</div>

	<center class="center">

		<!-- Not editing mode -->
		<div id="classInfo">
			<h4 class="firstTitle">Class #<span id="currentClass"></span></h4>

			<h6 class=""><span id="currentTitle"></span></h6>
		</div>

		<!-- Editing mode -->
		<div id="editClassInfo" style="display:none">
			<h4>
				Edit this class:
			</h4>
			<form id="editClassInfo" method="post">
				<h6>Class number: 
					<input id="addClassCounter" name="class" type="text">
					</input>
				</h6>
				<h6> Title:
					<input id="addTitle" name="title" type="text">
					</input>
				</h6>
				<span title="Invited lecture or extraordinary class">
					<input type="checkbox" name="is_extra" value="is_extra"> Extra Class
				</span>

				<button onclick="">Save</button>
				<button onclick="">Cancel</button>
			</form>
		</div>



		<div style="margin-right: 2px" class="historycolumn" id="historycolumnDiv">
		<!--<p>Students on time:</p>-->
		<p>Attendance History Table:</p>
		<table id="studentsTable">
			<tr>
				<th>IST ID</th>
				<th>Name</th>
				<th>On time</th>
				<th></th>

			</tr>
			
			<template id="studentsTemplate">
				<tr class="clickable">
					<td></td>
					<td></td>
					<td class="td_Special" title="Change student's status (on time vs late)"></td>
					<td><button onclick="manuallyRemoveStudent(this)">-</button></td>
				</tr>
			</template>
		</table>
		
		<form id="formStudent" method="post" style="margin-top: 20px;margin-bottom: 90px">

			<tr title="ist_id">
				<td>
					<input id="inputadd_student" name="ist_id" placeholder="IST ID (ist1XXXXX)">

					  <input id="late_checkbox" type="checkbox" name="late" value="late">Late
					<button id="add_student" type="button" onclick="sendForm();" 
							title="">Add student</button>
				</td>
			</tr>
		</form>
		</div>


		<div style="margin-left: 20px" class="historycolumn" id="attempedstudentsDiv">
		<p>Students that failed to take the attendance:</p>
		<table id="attempedstudentsTable">
			<tr>
				<th>IST ID</th>
				<th colspan="2">Name</th>
			</tr>
			
			<template id="attempedstudentsTemplate">
				<tr>
					<td></td>
					<td></td>
					<td><button onclick="copyISTIDToAddStudent(this)">+</button></td>
				</tr>
			</template>
		</table>
		</div>

	</center>

</div>
	<div id="goUp_spacer">
		
	</div>
	<div id="goUp_div" title="Go up">
		<a id="goUp" href="#top">&#9650;</a>
	</div>

</div>

<div class="container" id="showFingerprintHistory" style="display: none">

	<div style="text-align: left">
		<a onclick="switchView(1);"	class="goBack previous round">
			&#8249;</a>
	</div>

	<center class="center">
		<h4 class="firstTitle">
			<span style="font-weight: bold" id="currentStudent"></span>'s fingerprint
		</h4>

		<table id="fingerprintTable">
			<tr>
				<th>User Agent</th>
				<th>IP</th>
			</tr>
			
			<template id="fingerprintTemplate">
				<tr>
					<td></td>
					<td></td>
				</tr>
			</template>


		</table>


		<h5 style="margin-top:30px">Attended the following classes:</h5>

		<table id="attendanceHistoryTable" style="margin-bottom: 90px">
			<tr>
				<th>Class</th>
				<th>On time</th>
			</tr>
			
			<template id="attendanceHistoryTemplate">
				<tr>
					<td></td>
					<td></td>
				</tr>
			</template>


		</table>
	</center>

</div>

<script>
document.getElementById("tsvlink_b").disabled = true;
const urlParams = new URLSearchParams(window.location.search);
let courseID = urlParams.get("c");
let historyTable_error = document.getElementById("historyTable_error");
if(courseID) {
	historyTable_error.innerHTML = "";
	loadHistory(courseID);
} else {
	historyTable_error.innerHTML = "CourseID not defined.";
	document.getElementById("historyTable").style.display = "none";
	document.getElementById("b_attendance").style.display = "none";
}
function goTo(url) {
	window.location.replace(url);
}

function editTitleNumber(button_element) {
	document.getElementById("classInfo").style.display = "none";
	document.getElementById("editClassInfo").style.display = "";
	document.getElementById("editButton").classList.add("active");

	var attedanceID = button_element.attendanceID;

	loadAttendanceInformation("/api/attendanceinfo?a="+attendanceID);
}

function loadAttendanceInformation(url) {
	var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if(this.readyState == 4) {
				if(this.status == 200) {
					//todo
				} else {
					console.log("Error loadAttendanceInformation:", this.status);
				}
			}
		};
		xhttp.open("GET", url, true);
		xhttp.send();
}

function loadHistory(courseID) {
	let url = "/api/history?c="+courseID;
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var history = JSON.parse(this.responseText);
				showHistory(history);
			} else {
				//todo
				console.log("Error loading history:", this.status);
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}
function showHistory(history_wrapper) {
	var template = document.getElementById("historyTemplate");
	var table = document.getElementById("historyTable");
	var history = history_wrapper.history.rows;
	table.ist_id = history_wrapper.history.ist_id;
	removeTrs(table.getElementsByTagName("tr"));
	document.getElementById("courseName_id").innerHTML = history_wrapper.courseName;
	if(history.length > 0) {
		document.getElementById("noAttendancesText").style.display = "none";
		for(let i = 0; i < history.length; i++) {
			let hist_i = history[i];
			addHistory(table, template, hist_i.attendanceID, hist_i.number, hist_i.title, hist_i.date, hist_i.code_type, hist_i.code_length, hist_i.total_time_s, hist_i.consecutive_codes, hist_i.count, hist_i.is_extra);
		} 
	} else {
		document.getElementById("historyTable").style.display = "none";
		document.getElementById("noAttendancesText").style.display = "";
	}
	
};
function addHistory(table, template, attendanceID, classcounter, mytitle, date, code_type, code_length, total_time_s, consecutive_codes, count, is_extra) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;
	tr_clone.myattendanceID = attendanceID;
	tr_clone.classcounter = classcounter;
	tr_clone.mytitle = mytitle;
	tds[0].innerText = (is_extra == 1) ? "-" : classcounter;
	
	for(let x = 1; x < tds.length - 1; x++) {	//a partir de "date"
		tds[x].innerText = arguments[x+3];
	}
	tr_clone.onclick = function() {
		loadStudents("/api/getattendancehistory?rid="+this.myattendanceID, this.classcounter, mytitle);
		switchView(1);
	};
	table.appendChild(tr_clone);
}
function loadName(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				document.getElementById("IST_NAME").innerHTML = this.responseText;
			} else {
				document.getElementById("IST_NAME").innerHTML = "<i>error getting username: " + this.status + "</i>";
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}
function loadStudents(url, classcounter, title) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var studentshistory = JSON.parse(this.responseText);
				showStudents(studentshistory, classcounter, title);
			} else {
				//todo
				console.log("Error loading students:", this.status);
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}
function removeTrs(old_tr) {
	for(let l = old_tr.length-1; l > 0; l--) {
		old_tr[l].parentElement.removeChild(old_tr[l]);
	}
}
function showStudents(studentshistory, classcounter, title) {
	var template = document.getElementById("studentsTemplate");
	var table = document.getElementById("studentsTable");
	var template_tried = document.getElementById("attempedstudentsTemplate");
	var table_tried = document.getElementById("attempedstudentsTable");
	var button_edit = document.getElementById("editButton");
	removeTrs(table.getElementsByTagName("tr"));
	removeTrs(table_tried.getElementsByTagName("tr"));
	var rows = studentshistory.rows;
	var rows_fingerprints = studentshistory.rows_fingerprints;
	var rows_studentsThatTried = studentshistory.rows_studentsThatTried;
	var rows_late = studentshistory.rows_late;
	var rows_manually = studentshistory.rows_manually;
	table.attendanceID = studentshistory.attendanceID;
	table.courseID = courseID;
	table.classcounter = classcounter;
	table_tried.classcounter = classcounter;
	table.title = title;
	button_edit.attendanceID = studentshistory.attendanceID;

	document.getElementById("currentTitle").innerHTML = title;
	document.getElementById("currentClass").innerHTML = classcounter;	

	for(let i = 0; i < rows.length; i++) {
		var studentCheating = isIn(rows_fingerprints, rows[i].ist_id);
		var studentLate = isIn(rows_late, rows[i].ist_id);
		var studentManually = isIn(rows_manually, rows[i].ist_id);
		addStudent(table, template, rows[i].ist_id, rows[i].name, studentLate, studentManually, studentCheating, false);
	}
	for(let j = 0; j < rows_studentsThatTried.length; j++) {
		addStudent(table_tried, template_tried, rows_studentsThatTried[j].ist_id, rows_studentsThatTried[j].name, false, false, false, true);
	}
};
function isIn(rows, ist_id) {
	for(let x = 0; x < rows.length; x++) {
		if(rows[x].ist_id == ist_id) {
			return true;
		}
	}
	return false;
}
function addStudent(table, template, ist_id, name, late, manually, studentCheating, isTableTried) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;
	tr_clone.ist_id = ist_id;
	tr_clone.std_name = name;
	if(studentCheating){
		tr_clone.classList.add("less_suspicious");
	}
	if(isTableTried == true) {
		for(let x = 0; x < tds.length - 1; x++) {
			tds[x].innerText = arguments[x+2];
		}
	} else {
		for(let x = 0; x < tds.length - 2; x++) {		// -2 por causa da coluna "extra" e do "on time"
			tds[x].innerText = arguments[x+2];
		}
		if(late) {			// coluna: on time
			tds[2].classList.add("toRed");
			tds[2].innerHTML = "X";	//cruz
		} else {
			tds[2].classList.add("toGreen");
			tds[2].innerHTML = "&#10004;";	//check
		}
	
	tds[2].my_isLate = late;
	tds[0].onclick = tds[1].onclick = function() {
		let table = document.getElementById("studentsTable");
		let tr = this.parentElement;
		document.getElementById("currentStudent").innerHTML = tr.std_name;
		loadFingerprint("/api/fingerprint?f="+table.attendanceID+"&i="+tr.ist_id);
		loadStudentsAttendanceHistory("/api/students/attendanceHistory?n=" + tr.ist_id);
		switchView(2);
	};
	tds[2].onclick = function() {
		let table = document.getElementById("studentsTable");
		let tr = this.parentElement;
		let new_isLate = !this.my_isLate;	//toggle state
		json = {};
		json.a = table.attendanceID;
		json.i = tr.ist_id;
		json.late = new_isLate;
		loadisLate("/api/setLate", json, this);
	};
	}
	table.appendChild(tr_clone);
}
function manuallyRemoveStudent(button_element) {
	if(confirm("Are you sure you want to remove this students from this attendance?")) {
	button_element.parentElement.parentElement.classList.add('removedStyle');
	var ist_id = button_element.parentElement.parentElement.ist_id;
	var attendanceID = button_element.parentElement.parentElement.parentElement.attendanceID;
	var classcounter = button_element.parentElement.parentElement.parentElement.classcounter;
	removeStudent('/api/manuallyRemoveStudent?i='+ist_id+'&a='+attendanceID, button_element, attendanceID, classcounter);
	}
}
function manuallyRemoveAttendance(button_element, event) {
	if(confirm("Are you sure you want to delete this attendance?")) {
		var attendanceID = button_element.parentElement.parentElement.myattendanceID;
		var prof_id = button_element.parentElement.parentElement.parentElement.ist_id;
		removeAttendance('api/manuallyRemoveAttendance?a='+attendanceID+'&i='+prof_id, button_element, attendanceID);
	}
	event.preventDefault();
}
function removeAttendance(url, button_element, attendanceID) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				button_element.disabled=true;
				loadHistory();
				switchView(0);
			} else {
				console.log("Error removing attendance:", this.status);
				alert("Error removing attendance. Try again please.");
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}
function removeStudent(url, button_element, attendanceID, classcounter) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				button_element.disabled=true;
				// to reload the page
				loadStudents('/api/getattendancehistory?rid='+attendanceID, classcounter);
			} else {
				console.log("Error removing student:", this.status);
				alert("Error removing student. Try again please.");
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}
function loadFingerprint(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var fingerprint = JSON.parse(this.responseText);
				showFingerprint(fingerprint);
			} else {
				console.log("Error loading fingerprint:", this.status);
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}
function loadStudentsAttendanceHistory(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var attendance_history = JSON.parse(this.responseText);
				showStudentsAttendanceHistory(attendance_history);
			} else {
				//todo
				console.log("Error loading fingerprint:", this.status);
			}
		}
	};
	xhttp.open("GET", url, true);
	xhttp.send();
}
function showFingerprint(fingerprint) {
	var template = document.getElementById("fingerprintTemplate");
	var table = document.getElementById("fingerprintTable");
	removeTrs(table.getElementsByTagName("tr"));
	for(let i = 0; i < fingerprint.length; i++) {
		addFingerprint(table, template, fingerprint[i].useragent, fingerprint[i].ip);
	} 
};
function showStudentsAttendanceHistory(attendance_history) {
	var template = document.getElementById("attendanceHistoryTemplate");
	var table = document.getElementById("attendanceHistoryTable");
	removeTrs(table.getElementsByTagName("tr"));
	for(let i = 0; i < attendance_history.length; i++) {
		let isLate;
		if(attendance_history[i].late == 1) {
			isLate = true;
		} else {
			isLate = false;
		}
		if(attendance_history[i].number != null) {
			addStudentsAttendanceHistory(table, template, attendance_history[i].number, attendance_history[i].late);
		}
	} 
};
function addFingerprint(table, template, useragent, ip) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;
	for(let x = 0; x < tds.length; x++) {
		tds[x].innerText = arguments[x+2];
	}
	tr_clone.onclick = function() {
	};
	table.appendChild(tr_clone);
}
function addStudentsAttendanceHistory(table, template, number, late) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;
	if(late == 1) {			// coluna: on time
		tds[1].classList.add("toRed");
		tds[1].innerHTML = "X";	//cruz
	} else {
		tds[1].classList.add("toGreen");
		tds[1].innerHTML = "&#10004;";	//check
	}
	for(let x = 0; x < tds.length - 1; x++) {
		tds[x].innerText = arguments[x+2];
	}
	tr_clone.onclick = function() {
	};
	table.appendChild(tr_clone);
}
function sendForm(){
	var formEl = document.getElementById("formStudent");
	var data = new FormData(formEl);
	var o = {};
	var table = document.getElementById("studentsTable");
	o.attendanceID = table.attendanceID;
	for(var e of data) {
		o[e[0]] = e[1];
	}
	
	console.log(o);
	var json_string = JSON.stringify(o);
	var xhttp = new XMLHttpRequest();
	var url = "/api/addmanually";
	if(confirm("Are you sure you want to add this students?")) {
		xhttp.onreadystatechange = function() {
			if(this.readyState == 4 && this.status == 200) {
				var json = JSON.parse(this.responseText);
				var template = document.getElementById("studentsTemplate");
				var table = document.getElementById("studentsTable");
				var classcounter = table.classcounter;
				addStudent(table, template, o.ist_id, "(loading)");
				var inputadd_student = document.getElementById("inputadd_student");
				inputadd_student.value = "";
				loadStudents('/api/getattendancehistory?rid='+table.attendanceID, classcounter);
			}
		};
	xhttp.open("POST", url, true);
	xhttp.send(json_string);
	}
}
function loadisLate(url, json, td) {
	var xhttp = new XMLHttpRequest();
	if(confirm("Are you sure you want change the student's status?")) {
		xhttp.onreadystatechange = function() {
			if(this.readyState == 4) {
				if(this.status == 200) {
					if(td.innerText == "X") {
						td.classList.remove("toRed");
						td.classList.add("toGreen");
						td.innerHTML = "&#10004;";
					} else {
						td.classList.remove("toGreen");
						td.classList.add("toRed");
						td.innerHTML = "X";
					}
				} else {
					console.log("Error loading isLate", this.status);
					alert("Could not change student's status");
				}
			}
		};
	}
	var json_string = JSON.stringify(json);
	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}
function copyISTIDToAddStudent(button) {
	var inputadd_student = document.getElementById("inputadd_student");
	inputadd_student.value = button.parentElement.parentElement.ist_id;
}
function switchView(arg){
	switch(arg) {
		case 0:
			document.getElementById("showHistoryofProfessor").style.display = "";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 1:
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 2:
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "";
			break;
		default:
			console.log("unknown arg", arg);
			break;
	}
}
loadName("/api/name");
</script>