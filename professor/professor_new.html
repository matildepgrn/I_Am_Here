<!DOCTYPE html>
<head>
  <title>I Am Here!</title>
</head>

<link rel="stylesheet" type="text/css" href="/style.css">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3pro.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

<ul>
	<li style="float:left"><span class="logoname" >I Am Here!</span></li>

	<li style="float:right"><a href="/logout">Log Out</a></li>
	<li style="float:right"><span class="name" id="IST_NAME">Name</span></li>
</ul>

<div class="container" id="showHistoryofProfessor">	
	<center class="center">

	<a href="/professor/classes" class="previous round">&#8249;</a>
		
	<button id="b_attendance" type="button"
		onclick="goTo('/professor/attendance?c='+courseID)"
		title="Generate a new sequence">Start new attendance</button>

	<table id="historyTable">
			<tr>
				<th rowspan="2">Class #</th>
				<th rowspan="2">Date</th>
				<th colspan="2">Code</th>
				<th rowspan="2">Time</th>
				<th rowspan="2">Consecutive codes</th>
				<th rowspan="2"># Students</th>
				<th rowspan="2"></th>
			</tr>
			<tr>
				<th>Type</th>
				<th>Length</th>
			</tr>
			
			<template id="historyTemplate">
				<tr class="clickable">
					<td class="classCounter"></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td title="Remove attendance"><button onclick="return manuallyRemoveAttendance(this, event)">-</button></td>
				</tr>
			</template>


		</table>

		<p id="historyTable_error"></p>

	</center>
</div>

<div class="container" id="showStudentsHistory" style="display: none">
	<center class="center">
		<div style="text-align: left;">
			<a onclick="switchView(0);"	class="previous round">&#8249;</a>
		</div>

		<div style="margin-right: 40px" class="historycolumn">
		<p>Students on time:</p>
		<table id="studentsTable">
			<tr>
				<th>IST ID</th>
				<th colspan="2">Name</th>

			</tr>
			
			<template id="studentsTemplate">
				<tr class="clickable">
					<td></td>
					<td></td>
					<td><button onclick="manuallyRemoveStudent(this)">-</button></td>
				</tr>
			</template>
		</table>
		<form id="formStudent" method="post" style="margin-top: 10px">

			<tr title="ist_id">
				<td>
					<input id="inputadd_student" name="ist_id" placeholder="IST ID (ist1XXXXX)">
					<select name="ontime" required>
						<option value="ontime">On time</option>
						<option value="late" selected="selected">Late</option>
					</select>
					<button id="add_student" type="button" onclick="sendForm();" 
							title="">Add student</button>
				</td>
			</tr>
		</form>
		</div>


		<div style="margin-left: 40px" class="historycolumn">
		<p>Students that failed to take the attendance:</p>
		<table id="attempedstudentsTable">
			<tr>
				<th>IST ID</th>
				<th colspan="2">Name</th>
			</tr>
			
			<template id="attempedstudentsTemplate">
				<tr>
					<td></td>
					<td></td>
					<td><button onclick="copyISTIDToAddStudent(this)">+</button></td>
				</tr>
			</template>
		</table>
		</div>

	</center>
</div>

<div class="container" id="showFingerprintHistory" style="display: none">
	<center class="center">
		<div style="text-align: left">
			<a onclick="switchView(1);"	class="previous round">&#8249;</a>
		</div>

		<table id="fingerprintTable">
			<tr>
				<th>User Agent</th>
				<th>IP</th>
			</tr>
			
			<template id="fingerprintTemplate">
				<tr>
					<td></td>
					<td></td>
				</tr>
			</template>


		</table>
	</center>
</div>

<script>

const urlParams = new URLSearchParams(window.location.search);
let courseID = urlParams.get("c");
let historyTable_error = document.getElementById("historyTable_error");
if(courseID) {
	historyTable_error.innerHTML = "";
	loadHistory(courseID);
} else {
	historyTable_error.innerHTML = "CourseID not defined.";
	document.getElementById("historyTable").style.display = "none";
	document.getElementById("b_attendance").style.display = "none";
}

function goTo(url) {
	window.location.replace(url);
}

function loadHistory(courseID) {
	let url = "/api/history?c="+courseID;
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var history = JSON.parse(this.responseText);
				showHistory(history);
			} else {
				//todo
				console.log("Error loading history:", this.status);
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function showHistory(history_wrapper) {
	var template = document.getElementById("historyTemplate");
	var table = document.getElementById("historyTable");
	var history = history_wrapper.rows;
	table.ist_id = history_wrapper.ist_id;

	removeTrs(table.getElementsByTagName("tr"));

	for(let i = 0; i < history.length; i++) {
		addHistory(table, template, history[i].attendanceID, i+1, history[i].date, history[i].code_type, history[i].code_length, history[i].total_time_s, history[i].consecutive_codes, history[i].count);
	} 
};

function addHistory(table, template, attendanceID, classcounter, date, code_type, code_length, total_time_s, consecutive_codes, count) {

	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;

	tr_clone.myattendanceID = attendanceID;

	for(let x = 0; x < tds.length - 1; x++) {
		tds[x].innerText = arguments[x+3];
	}

	tr_clone.onclick = function() {
		loadStudents("/api/getattendancehistory?rid="+this.myattendanceID);
		switchView(1);
	};

	table.appendChild(tr_clone);
}

function loadName(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				document.getElementById("IST_NAME").innerHTML = this.responseText;
			} else {
				document.getElementById("IST_NAME").innerHTML = "<i>error getting username: " + this.status + "</i>";
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function loadStudents(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var studentshistory = JSON.parse(this.responseText);
				showStudents(studentshistory);
			} else {
				//todo
				console.log("Error loading students:", this.status);
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function removeTrs(old_tr) {
	for(let l = old_tr.length-1; l > 0; l--) {
		old_tr[l].parentElement.removeChild(old_tr[l]);
	}
}

function showStudents(studentshistory) {
	var template = document.getElementById("studentsTemplate");
	var table = document.getElementById("studentsTable");
	var template_tried = document.getElementById("attempedstudentsTemplate");
	var table_tried = document.getElementById("attempedstudentsTable");

	removeTrs(table.getElementsByTagName("tr"));
	removeTrs(table_tried.getElementsByTagName("tr"));

	var rows = studentshistory.rows;
	var rows_fingerprints = studentshistory.rows_fingerprints;
	var rows_studentsThatTried = studentshistory.rows_studentsThatTried;
	table.attendanceID = studentshistory.attendanceID;

	for(let i = 0; i < rows.length; i++) {
		var studentCheating = isCheating(rows_fingerprints, rows[i].ist_id);
		addStudent(table, template, rows[i].ist_id, rows[i].name, studentCheating);
	}

	for(let j = 0; j < rows_studentsThatTried.length; j++) {
		addStudent(table_tried, template_tried, rows_studentsThatTried[j].ist_id, rows_studentsThatTried[j].name, false);
	}

};

function isCheating(rows_fingerprints, ist_id) {
	return rows_fingerprints.includes(ist_id);
}

function addStudent(table, template, ist_id, name, studentCheating) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;

	tr_clone.ist_id = ist_id;
	if(studentCheating){
		tr_clone.classList.add("less_suspicious");
	}

	for(let x = 0; x < tds.length - 1; x++) {		// -1 por causa da coluna "extra"
		tds[x].innerText = arguments[x+2];
	}

	tds[1].onclick = function() {
		var table = document.getElementById("studentsTable");
		loadFingerprint("/api/fingerprint?f="+table.attendanceID+"&i="+this.parentElement.ist_id);
		switchView(2);
	};

	table.appendChild(tr_clone);
}

function manuallyRemoveStudent(button_element) {
	if(confirm("Are you sure you want to remove this students from this attendance?")) {
	button_element.parentElement.parentElement.classList.add('removedStyle');
	var ist_id = button_element.parentElement.parentElement.ist_id;
	var attendanceID = button_element.parentElement.parentElement.parentElement.attendanceID;
	removeStudent('/api/manuallyRemoveStudent?i='+ist_id+'&a='+attendanceID, button_element, attendanceID);
	}
}

function manuallyRemoveAttendance(button_element, event) {

	if(confirm("Are you sure you want to delete this attendance?")) {
		var attendanceID = button_element.parentElement.parentElement.myattendanceID;
		var prof_id = button_element.parentElement.parentElement.parentElement.ist_id;
		removeAttendance('api/manuallyRemoveAttendance?a='+attendanceID+'&i='+prof_id, button_element, attendanceID);
	}

	event.preventDefault();
}

function removeAttendance(url, button_element, attendanceID) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				button_element.disabled=true;
				loadHistory();
				switchView(0);
			} else {
				console.log("Error removing attendance:", this.status);
				alert("Error removing attendance. Try again please.");
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function removeStudent(url, button_element, attendanceID) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				button_element.disabled=true;
				// to reload the page
				loadStudents('/api/getattendancehistory?rid='+attendanceID);
			} else {
				console.log("Error removing student:", this.status);
				alert("Error removing student. Try again please.");
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function loadFingerprint(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var fingerprint = JSON.parse(this.responseText);
				showFingerprint(fingerprint);
			} else {
				//todo
				console.log("Error loading fingerprint:", this.status);
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function showFingerprint(fingerprint) {
	var template = document.getElementById("fingerprintTemplate");
	var table = document.getElementById("fingerprintTable");

	removeTrs(table.getElementsByTagName("tr"));

	for(let i = 0; i < fingerprint.length; i++) {
		addFingerprint(table, template, fingerprint[i].useragent, fingerprint[i].ip);
	} 
};

function addFingerprint(table, template, useragent, ip) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;

	for(let x = 0; x < tds.length; x++) {
		tds[x].innerText = arguments[x+2];
	}

	tr_clone.onclick = function() {
	};

	table.appendChild(tr_clone);
}

function sendForm(){
	var formEl = document.getElementById("formStudent");
	var data = new FormData(formEl);
	var o = {};

	var table = document.getElementById("studentsTable");
	o.attendanceID = table.attendanceID;

	for(var e of data) {
		o[e[0]] = e[1];
	}
	
	var json_string = JSON.stringify(o);

	var xhttp = new XMLHttpRequest();
	var url = "/api/addmanually";
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			var json = JSON.parse(this.responseText);
			var template = document.getElementById("studentsTemplate");
			var table = document.getElementById("studentsTable");
			addStudent(table, template, o.ist_id, "(loading)");

			var inputadd_student = document.getElementById("inputadd_student");
			inputadd_student.value = "";
			loadStudents('/api/getattendancehistory?rid='+table.attendanceID);
		}
	};

	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}

function copyISTIDToAddStudent(button) {
	var inputadd_student = document.getElementById("inputadd_student");
	inputadd_student.value = button.parentElement.parentElement.ist_id;
}

function switchView(arg){
	switch(arg) {
		case 0:
			document.getElementById("showHistoryofProfessor").style.display = "";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 1:
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 2:
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "";
			break;
		default:
			console.log("unknown arg", arg);
			break;
	}
}

loadName("/api/name");

</script>