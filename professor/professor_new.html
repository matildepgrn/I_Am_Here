<!DOCTYPE html>
<head>
  <title>I Am Here!</title>
</head>

<link rel="stylesheet" type="text/css" href="/style.css">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3pro.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

<ul>
	<li style="float:left"><span class="logoname" >I Am Here!</span></li>

	<li style="float:right"><a href="/logout">Log Out</a></li>
	<li style="float:right"><span class="name" id="IST_NAME">Name</span></li>
</ul>

<div class="container" id="showHistoryofProfessor">
	<center class="center">
		
		<button id="b_attendance" type="button"
		onclick="goTo('/professor/attendance')"
		title="Generate a new sequence">Start new attendance</button>

		<table id="historyTable">
			<tr>
				<th rowspan="2">Class #</th>
				<th rowspan="2">Date</th>
				<th colspan="2">Code</th>
				<th rowspan="2">Time</th>
				<th rowspan="2">Consecutive codes</th>
				<!--<th rowspan="2"># Students</th>-->
			</tr>
			<tr>
				<th>Type</th>
				<th>Length</th>
			</tr>
			
			<template id="historyTemplate">
				<tr class="clickable">
					<td class="classCounter"></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<!--<td></td>-->
				</tr>
			</template>


		</table>

	</center>
</div>

<div class="container" id="showStudentsHistory" style="display: none">
	<center class="center">
		<div style="text-align: left">
			<a onclick="switchView(0);"	class="previous round">&#8249;</a>
		</div>

		<table id="studentsTable">
			<tr>
				<th>IST ID</th>
				<th>Name</th>
			</tr>
			
			<template id="studentsTemplate">
				<tr class="clickable">
					<td></td>
					<td></td>
				</tr>
			</template>
		</table>
		<form id="formStudent" method="post" style="margin-top: 10px">

			<tr title="ist_id">
				<td>
					<input id="inputadd_student" name="ist_id" placeholder="IST ID (ist1XXXXX)">
					<button id="add_student" type="button" onclick="sendForm();" 
							title="">Add student</button>
				</td>
			</tr>
		</form>

		<p>Students that failed to take the attendance:</p>
		<table id="attempedstudentsTable">
			<tr>
				<th>IST ID</th>
				<th colspan="2">Name</th>
			</tr>
			
			<template id="attempedstudentsTemplate">
				<tr>
					<td></td>
					<td></td>
					<td><button onclick="copyISTIDToAddStudent(this)">+</button></td>
				</tr>
			</template>
		</table>

	</center>
</div>

<div class="container" id="showFingerprintHistory" style="display: none">
	<center class="center">
		<div style="text-align: left">
			<a onclick="switchView(1);"	class="previous round">&#8249;</a>
		</div>

		<table id="fingerprintTable">
			<tr>
				<th>User Agent</th>
				<th>IP</th>
			</tr>
			
			<template id="fingerprintTemplate">
				<tr>
					<td></td>
					<td></td>
				</tr>
			</template>


		</table>
	</center>
</div>

<script>

function goTo(url) {
	window.location.replace(url);
}

function loadHistory(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var history = JSON.parse(this.responseText);
				showHistory(history);
			} else {
				//todo
				console.log("Error loading history:", this.status);
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function showHistory(history) {
	var template = document.getElementById("historyTemplate");
	var table = document.getElementById("historyTable");

	for(let i = 0; i < history.length; i++) {
		addHistory(table, template, history[i].attendanceID, i+1, history[i].date, history[i].code_type, history[i].code_length, history[i].total_time_s, history[i].consecutive_codes);
	} 
};

function addHistory(table, template, attendanceID, classcounter, date, code_type, code_length, total_time_s, consecutive_codes) {

	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;

	tr_clone.myattendanceID = attendanceID;

	for(let x = 0; x < tds.length; x++) {
		tds[x].innerText = arguments[x+3];
	}

	tr_clone.onclick = function() {
		loadStudents("/api/getattendancehistory?rid="+this.myattendanceID);
		switchView(1);
	};

	table.appendChild(tr_clone);
}

function loadName(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				document.getElementById("IST_NAME").innerHTML = this.responseText;
			} else {
				document.getElementById("IST_NAME").innerHTML = "<i>error getting username: " + this.status + "</i>";
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function loadStudents(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var studentshistory = JSON.parse(this.responseText);
				showStudents(studentshistory);
			} else {
				//todo
				console.log("Error loading students:", this.status);
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function removeTrs(old_tr) {
	for(let l = old_tr.length-1; l > 0; l--) {
		old_tr[l].parentElement.removeChild(old_tr[l]);
	}
}

function showStudents(studentshistory) {
	var template = document.getElementById("studentsTemplate");
	var table = document.getElementById("studentsTable");
	var template_tried = document.getElementById("attempedstudentsTemplate");
	var table_tried = document.getElementById("attempedstudentsTable");

	removeTrs(table.getElementsByTagName("tr"));
	removeTrs(table_tried.getElementsByTagName("tr"));

	var rows = studentshistory.rows;
	var rows_fingerprints = studentshistory.rows_fingerprints;
	var rows_studentsThatTried = studentshistory.rows_studentsThatTried;
	table.attendanceID = studentshistory.attendanceID;

	for(let i = 0; i < rows.length; i++) {
		var studentCheating = isCheating(rows_fingerprints, rows[i].ist_id);
		addStudent(table, template, rows[i].ist_id, rows[i].name, studentCheating);
	}

	for(let j = 0; j < rows_studentsThatTried.length; j++) {
		addStudent(table_tried, template_tried, rows_studentsThatTried[j].ist_id, rows_studentsThatTried[j].name, false);
	}

};

function isCheating(rows_fingerprints, ist_id) {
	for(let i = 0; i < rows_fingerprints.length; i++) {
		if(rows_fingerprints[i].ist_id == ist_id) {
			return true;
		}
	}
	return false;
}

function addStudent(table, template, ist_id, name, studentCheating) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;

	tr_clone.ist_id = ist_id;
	if(studentCheating){
		tr_clone.classList.add("less_suspicious");
	}

	for(let x = 0; x < tds.length - 1; x++) {		// -1 por causa da coluna "extra"
		tds[x].innerText = arguments[x+2];
	}

	tds[1].onclick = function() {
		var table = document.getElementById("studentsTable");
		loadFingerprint("/api/fingerprint?f="+table.attendanceID+"&i="+this.ist_id);
		switchView(2);
	};

	table.appendChild(tr_clone);
}

function loadFingerprint(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				var fingerprint = JSON.parse(this.responseText);
				showFingerprint(fingerprint);
			} else {
				//todo
				console.log("Error loading fingerprint:", this.status);
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

function showFingerprint(fingerprint) {
	var template = document.getElementById("fingerprintTemplate");
	var table = document.getElementById("fingerprintTable");

	removeTrs(table.getElementsByTagName("tr"));

	for(let i = 0; i < fingerprint.length; i++) {
		addFingerprint(table, template, fingerprint[i].useragent, fingerprint[i].ip);
	} 
};

function addFingerprint(table, template, useragent, ip) {
	var tr_clone = template.content.querySelector("tr").cloneNode(true);
	var tds = tr_clone.children;

	for(let x = 0; x < tds.length; x++) {
		tds[x].innerText = arguments[x+2];
	}

	tr_clone.onclick = function() {
	};

	table.appendChild(tr_clone);
}

function sendForm(){
	var formEl = document.getElementById("formStudent");
	var data = new FormData(formEl);
	var o = {};

	var table = document.getElementById("studentsTable");
	o.attendanceID = table.attendanceID;

	for(var e of data) {
		o[e[0]] = e[1];
	}
	
	var json_string = JSON.stringify(o);

	var xhttp = new XMLHttpRequest();
	var url = "/api/addmanually";
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			var json = JSON.parse(this.responseText);
			var template = document.getElementById("studentsTemplate");
			var table = document.getElementById("studentsTable");
			addStudent(table, template, o.ist_id, "");
		}
	};

	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}

function copyISTIDToAddStudent(button) {
	var inputadd_student = document.getElementById("inputadd_student");
	inputadd_student.value = button.parentElement.parentElement.ist_id;
}

function switchView(arg){
	switch(arg) {
		case 0:
			document.getElementById("showHistoryofProfessor").style.display = "";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 1:
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "";
			document.getElementById("showFingerprintHistory").style.display = "none";
			break;
		case 2:
			document.getElementById("showHistoryofProfessor").style.display = "none";
			document.getElementById("showStudentsHistory").style.display = "none";
			document.getElementById("showFingerprintHistory").style.display = "";
			break;
		default:
			console.log("unknown arg", arg);
			break;
	}
}

loadName("/api/name");
loadHistory("/api/history");

</script>