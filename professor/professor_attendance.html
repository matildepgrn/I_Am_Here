<!DOCTYPE html>
<head>
  <title>I Am Here!</title>
</head>

<link rel="stylesheet" type="text/css" href="/style.css">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3pro.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

<ul>
	<li style="float:left"><span class="logoname">I Am Here!</span></li>

	<li style="float:right"><a href="/logout">Log Out</a></li>
	<li style="float:right"><span class="name" id="IST_NAME"></span></li>
</ul>

<div class="center" id="maincontainer">
<div class="container" id="attendance_personalization">
		<a href="/professor/new" id="goBackToHistoryTable" class="previous round">&#8249;</a>
		
		<h3 style="text-align: center">
			Personalize the attendance checking:
		</h3>

		<table id="attendancePersonalization">
		<form id="formId" method="post">

			<tr title="Type of code">
				<td>Type:</td>
				<td>
					<input type="radio" name="code_type" value="L" checked>Letters
					<input type="radio" name="code_type" value="N">Numbers
					<input type="radio" name="code_type" value="LN">Letters and Numbers
				</td>
			</tr>

			<tr title="Number of characters of each code">
				<td>Length:</td>
				<td>
					<select name="code_length" required>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6" selected="selected">6</option>
						<option value="7">7</option>
						<option value="8">8</option>
						</select>
				</td>
			</tr>
			
			<tr title="Time to type each code in seconds">	
				<td>Time (in seconds) for each code:</td>
				<td>
					<select name="time" required>
						<option value="8">8</option>
						<option value="9">9</option>
						<option value="10" selected="selected">10</option>
						<option value="11">11</option>
						<option value="12">12</option>
					</select>
				</td>
			</tr>

			<tr title="Number of consecutive codes that the students will need to type">	
				<td>Consecutive codes:</td>
				<td>
					<select name="consecutivecodes" required>
						<option value="2">2</option>
						<option value="3" selected="selected">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6">6</option>
					</select>
				</td>
			</tr>
		</form>
		</table>

		<div style="text-align: center">
			<button class="Bigbutton" id="attendance-button"
				onclick="sendForm()" title="Create a session">
					Create session
			</button>
		</div>
</div>

<div id="attendance_links" style="display:none">
	<a onclick="switchView(0)"	class="previous round" id="back_qrcode">&#8249;</a>
	
	<div class="text-center" id="attendance_qrcode">
	</div>

	<p class="text-center" id="attendance_link" style="font-size: 40px">
		
	</p>

</div>

<div id="attendance_info" style="display:none">
	<!--<a onclick="switchView(1)" class="previous round">&#8249;</a>-->

	<p>Time remaining: <span id="time_remaining"></span>s</p>
	<p>Insert <span id="view_consecutivecodes"></span> consecutive codes:</p>
	<p><span id="randomcode"></span></p>

	<p id="status"> </p>

	<div class="text-center">
	<button id="b_start" type="button"
		onclick="switchView(2); startAttendance()"
		title="Generate a new sequence">Start</button>
	<button id="b_stop" type="button"
		disabled="true"
		onclick="stopAttendance(); switchView(1)"
		title="Stop current sequence">Pause</button>
</div>

<div class="text-center" id="button_finishAttendance" style="display:none" onclick="closeAttendance(); goTo('/professor/new');">
	<button>
		End session
	</button>
</div>
</div>

<div id="studentspresent" style="display:none">
	<p id="span_c">
		Students attending the class (<span id="studentsCount"></span>):
	</p>
	<pre id="showStudents">

	</pre>

</div>

<div class="text-center" id="buttons_startstop" style="display:none">
	<button id="b_start" type="button"
		onclick="switchView(2); startAttendance()"
		title="Generate a new sequence">Start</button>
	<button id="b_stop" type="button"
		disabled="true"
		onclick="stopAttendance(); switchView(1)"
		title="Stop current sequence">Pause</button>
</div>

</div> <!-- final do container -->


<script src="/qrcode.min.js"></script>

<script>

const urlParams = new URLSearchParams(window.location.search);
let courseID = urlParams.get("c");

if(courseID && courseID != 'undefined') {
	var goBackToHistoryTable = document.getElementById("goBackToHistoryTable");
	goBackToHistoryTable.href += "?c=" + courseID;
}

var students_count = 0;

function goTo(url) {
	url += window.location.search;
	window.location.replace(url);
}

var qrcode;

function stopAttendance() {
	loadStatus('/api/getcode/stop');
}

function generateQRCode(url) {
	if(qrcode) {
		qrcode.clear();
		qrcode.makeCode(url);
	}
	else {
		qrcode = new QRCode("attendance_qrcode", {
			text: url,
			width: 512,
			height: 512,
			colorDark : "#000000",
			colorLight : "#ffffff",
			correctLevel : QRCode.CorrectLevel.H
		});
	}
}

function loadName(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				document.getElementById("IST_NAME").innerHTML = this.responseText;
			} else {
				document.getElementById("IST_NAME").innerHTML = "<i>error getting username: " + this.status + "</i>";
			}
		}
	};

	xhttp.open("GET", url, true);
	xhttp.send();
}

var timer;

function closeAttendance() {
	stopAttendance();
	loadStatus("/api/closeAttendance");
}

function startAttendance() {
	timer = setInterval(loadStatusTimer, 1000);
	loadStatus('/api/getcode');
}

function stopTimer() {
	if(timer) {
		clearInterval(timer);	
	}
}

var randomID;

function loadStatus(url) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			//document.getElementById("status").innerHTML = this.responseText;
			updateStatus(this.responseText);
		}
	};

	var json = {};
	json.randomID = randomID;
	
	var json_string = JSON.stringify(json);

	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}

function updateStatus(jsonStr) {
	var json = JSON.parse(jsonStr);
	var code_element = document.getElementById("randomcode");
	if(json.current_code == undefined) {
		code_element.innerHTML = "&#8635;";
		code_element.classList.add("loadingIcon");
	} else if(json.current_code == "Expired") {
		code_element.classList.add("expired");
	} else {
		code_element.classList.remove("loadingIcon");
		code_element.classList.remove("expired");
		code_element.innerHTML = json.current_code;
	}
	var showStudents = document.getElementById("showStudents");
	var count = document.getElementById("studentsCount");
	if(json.studentsList && json.studentsList.length > 0) {
		students_count += json.studentsList.length;
		count.innerHTML = students_count;
		showStudents.innerHTML = json.studentsList.join('\n') + "\n" + showStudents.innerHTML;
	} else {
		count.innerHTML = 0;
	}
	var time_remaining = document.getElementById("time_remaining");
	time_remaining.innerHTML = json.time_ms;
	if(json.time_ms <= 3) {
		time_remaining.classList.add('time_remaining_short');
	} else {
		time_remaining.classList.remove('time_remaining_short');
	}
	updateButtons(json.running);

	if(json.running == false) {
		stopTimer();
	}
}

var state;

function switchView(arg){
	switch(arg) {
		case 0:
			document.getElementById("attendance_personalization").style.display = "";
			document.getElementById("buttons_startstop").style.display = "none";
			document.getElementById("button_finishAttendance").style.display = "none";
			document.getElementById("attendance_links").style.display = "none";
			document.getElementById("attendance_info").style.display = "none";
			document.getElementById("maincontainer").classList.remove("left");
			document.getElementById("maincontainer").classList.add("center");
			break;
		case 1:
			if(state == 2) {
				stopAttendance();
			}
			document.getElementById("back_qrcode").style.display = "";
			document.getElementById("attendance_personalization").style.display = "none";
			document.getElementById("buttons_startstop").style.display = "";
			document.getElementById("button_finishAttendance").style.display = "none";
			document.getElementById("attendance_links").style.display = "";
			document.getElementById("studentspresent").style.display = "none";
			document.getElementById("attendance_info").style.display = "none";
			document.getElementById("maincontainer").classList.remove("left");
			document.getElementById("maincontainer").classList.add("center");

			break;
		case 2:
			document.getElementById("back_qrcode").style.display = "none";
			document.getElementById("attendance_personalization").style.display = "none";
			document.getElementById("buttons_startstop").style.display = "none";
			document.getElementById("studentspresent").style.display = "";
			document.getElementById("attendance_links").style.display = "";
			document.getElementById("maincontainer").classList.add("left");
			document.getElementById("maincontainer").classList.remove("center");
			document.getElementById("attendance_info").style.display = "";
			document.getElementById("button_finishAttendance").style.display = "";
			break;
		default:
			console.log("unknown arg", arg);
			break;
	}
	state = arg;
}

function updateButtons(isStarted){
	document.getElementById("b_start").disabled = isStarted;
	document.getElementById("b_stop").disabled = !isStarted;
}

function loadStatusTimer() {
	loadStatus('/api/status');
}

function sendForm(){
	var formEl = document.getElementById("formId");
	var data = new FormData(formEl);
	var o = {};

	if(courseID && courseID != 'undefined') {
		o.courseID = courseID;
	}

	for(var e of data) {
		o[e[0]] = e[1];
	}
	
	var json_string = JSON.stringify(o);

	var xhttp = new XMLHttpRequest();
	var url = "/api/createAttendanceSession";
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			var json = JSON.parse(this.responseText);
			randomID = json.randomID;
			generateQRCode(json.url_complete);
			document.getElementById("attendance_link").innerHTML = json.url;
			document.getElementById("view_consecutivecodes").innerHTML = o.consecutivecodes;
			switchView(1);
		}
	};

	xhttp.open("POST", url, true);
	xhttp.send(json_string);
}

loadName("/api/name");

</script>